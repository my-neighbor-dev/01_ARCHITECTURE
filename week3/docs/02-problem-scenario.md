# 2. 문제 상황: 데이터 소유권 체크 필요성

## 질문

> **"Spring Security를 사용하면 모든 권한 체크가 끝나는 걸까요?"**

> 💡 **스터디 전에 생각해보기**: [질문들 모음](./00-questions.md)을 먼저 확인해보세요!

**생각해볼 점:**
- Role 기반 인가로 "수정 권한이 있는가?"는 체크할 수 있지만, "이 데이터를 수정할 자격이 있는가?"는 체크할 수 있을까?
- 사용자 A가 사용자 B의 데이터를 수정하려고 시도하면 어떻게 막을 수 있을까?
- 같은 권한을 가진 사용자라도, 자신이 만든 데이터만 수정할 수 있어야 한다면?

---

## 2.1 Role 기반 인가의 한계

### 현재 상황

강의 사이트는 여러 사용자가 사용하는 서비스입니다. 사용자별로 접근 가능한 기능에 대한 권한 제어를 **Role 기반**으로 수행하고 있습니다.

**Role 기반 인가의 역할:**
- "A라는 사용자가 수정 기능을 실행할 수 있는가?" ✅ 체크 가능
- "A라는 사용자가 B 데이터를 수정할 자격이 있는가?" ❌ 체크 불가능

### 문제 상황 예시

**시나리오:**
- 사용자 A(수정 권한 보유)가 사용자 B가 생성한 강의를 수정하려고 시도
- 시스템은 Role 기반 인가만 수행하므로 "수정 권한이 있네? OK!" 하고 통과
- 결과: **다른 사용자의 데이터 침범** 발생

**코드 예시:**

```java
@PreAuthorize("hasRole('USER')")
public LectureResponse updateLecture(Long lectureId, UserInfo userInfo) {
    // Role 기반 인가: 수정 권한이 있는가? ✅
    // 하지만 데이터 소유권 체크는 없음 ❌
    
    Lecture lecture = lectureRepository.findById(lectureId);
    // 사용자 B의 강의인데도 수정 가능!
    lecture.update(...);
    return lectureResponse;
}
```

**현직자의 시선:**
- "권한을 가진 토큰을 가지고 있으면 다른 데이터의 key 값을 알아내 악의적인 수정하는 데이터 침범이 발생할 위험이 있네"

---

## 2.2 데이터 소유권 체크 필요성

### 왜 필요한가?

**요구사항:**
- 데이터 수정 권한을 가진 사용자 A가 사용자 B가 생성한 강의를 수정하려고 시도한다면, 시스템은 `AccessDenied` 예외를 반환해야 합니다.

**기존 서비스 로직의 문제:**
- 데이터 소유권 체크 없이 권한 체크만 수행
- 권한을 가진 토큰을 가지고 있으면 다른 데이터의 key 값을 알아내 악의적인 수정 가능

---

## 2.3 도메인별 다른 소유권 조건

강의 사이트에서는 도메인에 따라서 데이터 소유권의 조건이 달랐기 때문에 조금 더 복잡한 인가 로직이 필요하였습니다.

### 예시 1: 강의 (Lecture)

**소유권 조건:**
- 자신이 생성한 강의만 조회 및 수정 가능

**예시:**
- 사용자 A가 생성한 강의
- 사용자 A만 조회 및 수정 가능 ✅
- 사용자 B는 조회 및 수정 불가능 ❌

**검증 기준:** `createdBy` (생성한 유저 ID)

### 예시 2: 그룹 (Group)

**소유권 조건:**
- 자신이 속한 그룹의 데이터만 조회 및 수정 가능

**예시:**
- 사용자 A가 그룹 1에 속해 있음
- 그룹 1의 데이터는 조회 및 수정 가능 ✅
- 그룹 2의 데이터는 조회 및 수정 불가능 ❌

**검증 기준:** `groupId` (사용자가 속한 그룹 ID)

---

## 2.4 문제 요약

### 핵심 문제

1. **Role 기반 인가만으로는 부족함**
   - "무엇을 할 수 있는가"는 체크하지만 "누구의 데이터인가"는 체크하지 못함

2. **도메인별 다른 소유권 조건**
   - 강의: 사용자 단위 소유권
   - 그룹: 그룹 단위 소유권

3. **보안 취약점**
   - 다른 사용자의 데이터 침범 위험
   - 권한을 가진 사용자가 다른 데이터의 key 값을 알아내 악의적인 수정 가능

### 해결 방향

이러한 부적절한 인가 취약점을 해결하기 위해 몇 가지 접근 방식을 고민했습니다. 다음 챕터에서 어떤 시도를 했는지, 그리고 최종적으로 어떻게 해결했는지 알아보겠습니다.

---

## 정리

✅ **Role 기반 인가는 "무엇을 할 수 있는가"만 체크하고, "누구의 데이터인가"는 체크하지 못한다**

✅ **데이터 소유권 체크가 필요하지만, 도메인별로 다른 조건이 있어 복잡하다**

✅ **보안 취약점을 해결하기 위해 적절한 인가 로직이 필요하다**
