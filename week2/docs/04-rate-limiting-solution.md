# 4. Rate Limiting 해결 과정

## 질문

> **"무분별한 로그인 시도를 어떻게 막을 수 있을까요? 문제 해결 과정을 그려보세요."**

> 💡 **스터디 전에 생각해보기**: [질문들 모음](./00-questions.md)을 먼저 확인해보세요!

**생각해볼 점:**
- 공격자가 옆에 있다고 가정하고, 종이와 펜으로 어떻게 해결할 수 있을까?
- 1시간에 5번만 로그인 요청 가능하다면, 어떤 정보를 저장해야 할까?
- 시간이 지나면 데이터를 어떻게 처리해야 할까?
- 왜 DB가 아니라 캐시를 선택해야 할까?

---

## 4.1 문제 상황

**요구사항:**
- 1시간에 5번만 로그인 요청 가능
- 5번을 초과하면 처음 요청 시간을 기준으로 1시간 동안 로그인 차단
- 1시간이 지나면 다시 로그인 가능

**공격자 시나리오:**
- 공격자가 무분별하게 로그인 시도
- 비밀번호를 무작위로 시도하여 계정 탈취 시도

---

## 4.2 종이와 펜으로 해결하기

### Step 1: 초기 접근

**생각:**
- 공격자가 옆에 있다고 가정
- 종이에 기록해서 막아야 함

**초기 설계:**
```
종이에 기록:
- 이름: 홍길동
- 횟수: 3번
- 시작 시간: 14:00
```

**로직:**
1. 로그인 시도할 때마다 횟수 증가
2. 횟수가 5를 넘고, 시작 시간이 1시간 이내면 막기

**문제점:**
- 시작 시간과 횟수를 모두 저장해야 함
- 복잡함

---

### Step 2: 최적화

**생각:**
- 사실 처음 로그인한 시간만 저장하면 됨
- 횟수는 별도로 관리

**개선된 설계:**
```
종이 1:
- 이름: 홍길동
- 시작 시간: 14:00

종이 2:
- 이름: 홍길동
- 횟수: 3
```

**또는 더 간단하게:**
```
종이:
- 이름: 홍길동
- 시작 시간: 14:00
- 횟수: 3
```

**로직:**
1. 첫 로그인 시도: 시작 시간 저장, 횟수 = 1
2. 이후 로그인 시도: 횟수 증가
3. 횟수가 5를 넘고, 시작 시간이 1시간 이내면 막기

---

### Step 3: 자동 삭제 필요

**생각:**
- 1시간이 지나면 데이터를 삭제해야 함
- 1시간보다 전이면 데이터 삭제하고 다시 1부터 카운팅

**문제:**
- 종이에서는 자동 삭제가 불가능
- 사람이 직접 확인하고 삭제해야 함

**핵심 인사이트:**
> **이 데이터가 1시간보다 길게 저장될 필요가 없다!**

**결론:**
- DB는 영구 저장이 목적
- 이 데이터는 임시 데이터 (1시간 후 자동 삭제)
- **캐시를 사용해야 함!**

---

## 4.3 Redis 선택 이유

### 캐시의 TTL 기능

**Redis의 TTL 기능:**
- 데이터를 저장할 때 만료 시간 설정 가능
- 시간이 지나면 자동으로 삭제됨
- 별도의 삭제 로직 불필요

**예시:**
```java
// Redis에 저장 (1시간 TTL)
redis.set("rate_limit:login:01012345678", "1", 3600);

// 1시간 후 자동 삭제됨
// 별도 삭제 로직 불필요!
```

---

## 4.4 Redis 구현

### Key-Value 설계

**Key:**
- `rate_limit:login:{identifier}`
- 예: `rate_limit:login:01012345678`

**Value:**
- 횟수 (INCR로 증가)

**TTL:**
- 1시간 (3600초)

### 구현 로직

```java
public void checkRateLimit(String identifier) {
    String key = "rate_limit:login:" + identifier;
    
    // 횟수 증가 (없으면 1로 시작, 있으면 증가)
    Long count = redis.increment(key);
    
    // 첫 요청이면 TTL 설정
    if (count == 1) {
        redis.expire(key, 3600); // 1시간
    }
    
    // 5번 초과하면 차단
    if (count > 5) {
        throw new RateLimitExceededException("1시간에 5번만 로그인 가능합니다");
    }
}
```

**Redis 명령어:**
- `INCR key`: 값 증가 (없으면 1로 시작)
- `EXPIRE key seconds`: TTL 설정
- `TTL key`: 남은 시간 확인

---

## 4.5 왜 이렇게 할까?

### DB를 사용하면?

**문제점:**
- 영구 저장이 목적
- 자동 삭제 기능 없음
- 별도의 삭제 로직 필요 (스케줄러 등)
- 느림 (디스크 I/O)

### 캐시를 사용하면?

**장점:**
- TTL 기능으로 자동 삭제
- 빠름 (메모리 기반)
- 단순한 구현

**결론:**
- 임시 데이터는 캐시 사용
- 영구 데이터는 DB 사용

---

## 정리

✅ **문제 해결 과정을 단계별로 생각하는 것이 중요하다**

✅ **종이와 펜으로 먼저 설계하면 핵심을 파악할 수 있다**

✅ **임시 데이터는 캐시의 TTL 기능을 활용한다**

✅ **Redis의 INCR + TTL 조합으로 간단하게 Rate Limiting을 구현할 수 있다**
